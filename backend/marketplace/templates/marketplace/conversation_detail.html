{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Чат" %} - Marketplace{% endblock %}

{% block content %}
<div class="container py-8 max-w-4xl">
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg overflow-hidden">
        <!-- Chat Header -->
        <div class="bg-indigo-600 text-white p-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="{% url 'marketplace:conversation_list' %}" class="hover:bg-indigo-700 p-2 rounded">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div>
                    <h2 class="font-bold">{{ other_participant.get_full_name|default:other_participant.username }}</h2>
                    <p class="text-xs text-indigo-200">
                        {% if other_participant.is_specialist %}{% trans "Специалист" %}{% else %}{% trans "Клиент" %}{%
                        endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- Messages Container -->
        <div id="chat-messages" class="h-96 overflow-y-auto p-4 bg-slate-50 dark:bg-slate-900">
            {% for message in messages %}
            <div class="mb-4 {% if message.sender == request.user %}text-right{% endif %}">
                <div class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg
                        {% if message.sender == request.user %}
                            bg-indigo-600 text-white
                        {% else %}
                            bg-white dark:bg-slate-700 text-slate-900 dark:text-white
                        {% endif %}">
                    <p class="text-sm">{{ message.content }}</p>
                    <p class="text-xs opacity-70 mt-1">{{ message.created_at|date:"H:i" }}</p>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Message Input -->
        <div class="p-4 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700">
            <div class="flex gap-2">
                <input type="text" id="message-input"
                    class="flex-1 px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-slate-700 dark:text-white"
                    placeholder="{% trans 'Введите сообщение...' %}" autocomplete="off">
                <button id="send-button"
                    class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition">
                    {% trans "Отправить" %}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const conversationId = {{ conversation.id }};
    const currentUserId = {{ request.user.id }};
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const chatSocket = new WebSocket(
        wsScheme + '://' + window.location.host + '/ws/chat/' + conversationId + '/'
    );

    const messagesContainer = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');

    // Scroll to bottom
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    scrollToBottom();

    // WebSocket message handler
    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const isCurrentUser = data.sender_id === currentUserId;

        const messageDiv = document.createElement('div');
        messageDiv.className = 'mb-4 ' + (isCurrentUser ? 'text-right' : '');
        messageDiv.innerHTML = `
            <div class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${isCurrentUser
                ? 'bg-indigo-600 text-white'
                : 'bg-white dark:bg-slate-700 text-slate-900 dark:text-white'
            }">
                <p class="text-sm">${data.message}</p>
                <p class="text-xs opacity-70 mt-1">${new Date(data.created_at).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}</p>
            </div>
        `;

        messagesContainer.appendChild(messageDiv);
        scrollToBottom();
    };

    // Send message
    function sendMessage() {
        const message = messageInput.value.trim();
        if (message) {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInput.value = '';
        }
    }

    sendButton.onclick = sendMessage;
    messageInput.onkeypress = function (e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    };

    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };
</script>
{% endblock %}