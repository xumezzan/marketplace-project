{% extends 'base.html' %}

{% block title %}{{ task.title }} - Marketplace{% endblock %}

{% block content %}
<!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" -->
<div class="mb-4">
    <a href="{% url 'marketplace:tasks_list' %}" class="btn-back">
        <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –∑–∞—è–≤–æ–∫
    </a>
</div>

<div class="row g-4">
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–µ -->
    <div class="col-lg-8">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–¥–∞—á–∏ -->
        <div class="task-detail-card">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="task-detail-header">
                <h1 class="task-detail-title">{{ task.title }}</h1>
                <div class="task-detail-badges">
                    <span class="badge badge-category">{{ task.category.name }}</span>
                    <span class="badge badge-status badge-{{ task.status }}">
                        {{ task.get_status_display }}
                    </span>
                </div>
            </div>
            
            <div class="task-detail-body">
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="task-detail-section">
                    <div class="task-detail-meta">
                        <div class="meta-item">
                            <i class="bi bi-geo-alt"></i>
                            <span>{{ task.city }}</span>
                        </div>
                        {% if task.address %}
                        <div class="meta-item">
                            <i class="bi bi-geo-alt-fill"></i>
                            <span>{{ task.address }}</span>
                        </div>
                        {% endif %}
                        <div class="meta-item">
                            <i class="bi bi-person"></i>
                            <span>–ö–ª–∏–µ–Ω—Ç: {{ task.client.username }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-clock-history"></i>
                            <span>–°–æ–∑–¥–∞–Ω–æ {{ task.created_at|date:"d.m.Y –≤ H:i" }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- –ë—é–¥–∂–µ—Ç -->
                {% if task.budget_min or task.budget_max %}
                <div class="task-detail-section">
                    <h3 class="section-title">–ë—é–¥–∂–µ—Ç</h3>
                    <div class="budget-display">
                        {{ task.budget_display }}
                    </div>
                </div>
                {% endif %}
                
                <!-- –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ -->
                <div class="task-detail-section">
                    <h3 class="section-title">–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</h3>
                    <div class="task-description">
                        {{ task.description|linebreaks }}
                    </div>
                </div>
                
                <!-- –î–µ—Ç–∞–ª–∏ -->
                <div class="task-detail-section">
                    <h3 class="section-title">–î–µ—Ç–∞–ª–∏</h3>
                    <div class="task-details-grid">
                        {% if task.preferred_date %}
                        <div class="detail-item">
                            <i class="bi bi-calendar3"></i>
                            <div>
                                <div class="detail-label">–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–∞—è –¥–∞—Ç–∞</div>
                                <div class="detail-value">{{ task.preferred_date|date:"d.m.Y" }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if task.preferred_time %}
                        <div class="detail-item">
                            <i class="bi bi-clock"></i>
                            <div>
                                <div class="detail-label">–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è</div>
                                <div class="detail-value">{{ task.preferred_time|time:"H:i" }}</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–¥–µ–ª–∫–µ -->
        {% if deal %}
            <div class="deal-card">
                <div class="deal-header">
                    <h3 class="deal-title">
                        <i class="bi bi-handshake"></i> –°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞
                    </h3>
                    <span class="badge badge-status badge-{{ deal.status }}">
                        {{ deal.get_status_display }}
                    </span>
                </div>
                <div class="deal-body">
                    <div class="deal-info">
                        <div class="deal-info-item">
                            <span class="deal-info-label">–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç:</span>
                            <strong>{{ deal.specialist.username }}</strong>
                        </div>
                        <div class="deal-info-item">
                            <span class="deal-info-label">–§–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞:</span>
                            <strong class="deal-price">{{ deal.final_price }}</strong>
                        </div>
                        <div class="deal-info-item">
                            <span class="deal-info-label">–°–æ–∑–¥–∞–Ω–æ:</span>
                            <span>{{ deal.created_at|date:"d.m.Y –≤ H:i" }}</span>
                        </div>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–¥–µ–ª–∫–æ–π -->
                    {% if user.is_authenticated and user == deal.client %}
                        <div class="deal-actions mt-4">
                            {% if deal.status == 'pending' %}
                                <form method="post" action="{% url 'marketplace:mark_deal_paid' deal.id %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-accent">
                                        <i class="bi bi-check-circle"></i> –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–æ
                                    </button>
                                </form>
                            {% elif deal.status == 'paid' %}
                                <form method="post" action="{% url 'marketplace:mark_deal_completed' deal.id %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-accent">
                                        <i class="bi bi-check2-circle"></i> –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
                                    </button>
                                </form>
                            {% elif deal.status == 'completed' %}
                                <div class="alert alert-success mb-0">
                                    <i class="bi bi-check-circle"></i> –°–¥–µ–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
        
        <!-- –§–æ—Ä–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ñ—Ñ–µ—Ä–∞ (–¥–ª—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤) -->
        {% if user.is_authenticated and user.is_specialist and not deal %}
            {% if can_create_offer %}
                <div class="offer-form-card">
                    <h3 class="offer-form-title">
                        <i class="bi bi-send"></i> –û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è –Ω–∞ –∑–∞–¥–∞—á—É
                    </h3>
                    <form method="post" class="offer-form">
                        {% csrf_token %}
                        <input type="hidden" name="offer_form" value="1">
                        
                        <!-- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ -->
                        <div class="form-group">
                            <label for="{{ offer_form.proposed_price.id_for_label }}" class="form-label">
                                –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞
                                <span class="text-danger">*</span>
                            </label>
                            {{ offer_form.proposed_price }}
                            {% if offer_form.proposed_price.errors %}
                                <div class="form-error">
                                    {{ offer_form.proposed_price.errors }}
                                </div>
                            {% endif %}
                            {% if offer_form.proposed_price.help_text %}
                                <div class="form-help">{{ offer_form.proposed_price.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ -->
                        <div class="form-group">
                            <label for="{{ offer_form.message.id_for_label }}" class="form-label">
                                –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
                                <span class="text-danger">*</span>
                            </label>
                            {{ offer_form.message }}
                            {% if offer_form.message.errors %}
                                <div class="form-error">
                                    {{ offer_form.message.errors }}
                                </div>
                            {% endif %}
                            {% if offer_form.message.help_text %}
                                <div class="form-help">{{ offer_form.message.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- –û–±—â–∏–µ –æ—à–∏–±–∫–∏ —Ñ–æ—Ä–º—ã -->
                        {% if offer_form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ offer_form.non_field_errors }}
                            </div>
                        {% endif %}
                        
                        <button type="submit" class="btn btn-accent w-100">
                            <i class="bi bi-send"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫
                        </button>
                    </form>
                </div>
            {% elif has_existing_offer %}
                <div class="info-alert">
                    <i class="bi bi-info-circle"></i>
                    –í—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ —ç—Ç–æ–π –∑–∞–¥–∞—á–µ.
                </div>
            {% elif not task.can_receive_offers %}
                <div class="warning-alert">
                    <i class="bi bi-exclamation-triangle"></i>
                    –≠—Ç–∞ –∑–∞–¥–∞—á–∞ –±–æ–ª—å—à–µ –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
                </div>
            {% endif %}
        {% elif not user.is_authenticated %}
            <div class="info-alert">
                <i class="bi bi-info-circle"></i>
                –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∫–∞–∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
            </div>
        {% endif %}
    </div>
    
    <!-- –°–ø–∏—Å–æ–∫ –æ—Ç–∫–ª–∏–∫–æ–≤ -->
    <div class="col-lg-4">
        <div class="offers-sidebar">
            <h3 class="offers-sidebar-title">
                –û—Ç–∫–ª–∏–∫–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
                <span class="offers-count">{{ offers|length }}</span>
            </h3>
            
            {% if offers_with_ratings %}
                <div class="offers-list">
                    {% for item in offers_with_ratings %}
                        {% with offer=item.offer reviews_count=item.reviews_count %}
                        <div class="offer-card">
                            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç–∫–ª–∏–∫–∞ -->
                            <div class="offer-header">
                                <div class="offer-specialist">
                                    <strong>{{ offer.specialist.username }}</strong>
                                    {% if offer.specialist.rating and offer.specialist.rating > 0 %}
                                        <span class="offer-rating">
                                            ‚òÖ {{ offer.specialist.rating|floatformat:1 }}
                                            {% if reviews_count > 0 %}
                                                <small>({{ reviews_count }})</small>
                                            {% endif %}
                                        </span>
                                    {% else %}
                                        <span class="offer-rating text-muted" style="font-size: 0.875rem;">
                                            –ù–æ–≤—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç
                                        </span>
                                    {% endif %}
                                </div>
                                <div>
                                    {% if offer.status == 'accepted' %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> –í—ã–±—Ä–∞–Ω
                                        </span>
                                    {% else %}
                                        <span class="badge badge-status badge-{{ offer.status }}">
                                            {{ offer.get_status_display }}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- –¶–µ–Ω–∞ -->
                            <div class="offer-price">
                                üí∞ {{ offer.proposed_price }}
                            </div>
                            
                            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ -->
                            <div class="offer-message">
                                üí¨ {{ offer.message|truncatewords:30 }}
                            </div>
                            
                            <!-- –î–∞—Ç–∞ -->
                            <div class="offer-date">
                                <i class="bi bi-clock"></i> {{ offer.created_at|timesince }} –Ω–∞–∑–∞–¥
                            </div>
                            
                            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ -->
                            {% if user.is_authenticated and user == task.client %}
                                <div class="offer-actions mt-3">
                                    {% if offer.status == 'pending' and not deal and task.status == 'published' %}
                                        <form method="post" action="{% url 'marketplace:accept_offer' offer.id %}" class="d-inline w-100 mb-2">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-accent w-100">
                                                <i class="bi bi-check-circle"></i> –ü—Ä–∏–Ω—è—Ç—å –æ—Ñ—Ñ–µ—Ä
                                            </button>
                                        </form>
                                    {% endif %}
                                    
                                    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–∑—ã–≤–∞ (–µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏ –æ—Ç–∑—ã–≤ –µ—â–µ –Ω–µ –æ—Å—Ç–∞–≤–ª–µ–Ω) -->
                                    {% if task.status == 'completed' and not item.has_review %}
                                        <a href="{% url 'marketplace:create_review' task.id offer.specialist.id %}" class="btn btn-outline-primary w-100">
                                            <i class="bi bi-star"></i> –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
                                        </a>
                                    {% elif item.has_review %}
                                        <div class="alert alert-info mb-0 mt-2" style="padding: 8px 12px; font-size: 0.875rem;">
                                            <i class="bi bi-check-circle"></i> –û—Ç–∑—ã–≤ –æ—Å—Ç–∞–≤–ª–µ–Ω
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                        {% endwith %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-offers">
                    <i class="bi bi-inbox display-6 text-muted"></i>
                    <p class="text-muted mt-3">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∫–ª–∏–∫–æ–≤</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
