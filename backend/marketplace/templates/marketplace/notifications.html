{% extends 'base.html' %}
{% load static %}

{% block title %}Уведомления - Marketplace{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-50 dark:bg-slate-900 py-8">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Уведомления</h1>
                <p class="text-slate-500 dark:text-slate-400 mt-1">
                    {% if unread_count > 0 %}
                    {% blocktrans count counter=unread_count %}У вас {{ counter }} новое уведомление{% plural %}У вас {{
                    counter }} новых уведомлений{% endblocktrans %}
                    {% else %}
                    У вас нет новых уведомлений
                    {% endif %}
                </p>
            </div>
            {% if unread_count > 0 %}
            <button id="mark-all-read"
                class="text-sm text-indigo-600 hover:text-indigo-700 dark:text-indigo-400 font-medium">
                Отметить все как прочитанные
            </button>
            {% endif %}
        </div>

        <!-- Notifications List -->
        <div class="space-y-4">
            {% if notifications %}
            {% for notification in notifications %}
            <div
                class="bg-white dark:bg-slate-800 rounded-xl p-4 shadow-sm border border-slate-200 dark:border-slate-700 transition-colors {% if not notification.is_read %}bg-indigo-50/50 dark:bg-indigo-900/10 border-indigo-200 dark:border-indigo-800{% endif %}">
                <div class="flex gap-4">
                    <!-- Icon -->
                    <div class="flex-shrink-0">
                        <div
                            class="w-10 h-10 rounded-full flex items-center justify-center
                                {% if notification.type == 'booking' %}bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400
                                {% elif notification.type == 'message' %}bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400
                                {% elif notification.type == 'review' %}bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-400
                                {% else %}bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400{% endif %}">
                            <i class="bi 
                                    {% if notification.type == 'booking' %}bi-calendar-check
                                    {% elif notification.type == 'message' %}bi-chat-dots
                                    {% elif notification.type == 'review' %}bi-star
                                    {% else %}bi-bell{% endif %} text-xl"></i>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h3 class="text-base font-semibold text-slate-900 dark:text-white truncate pr-4">
                                {{ notification.title }}
                            </h3>
                            <span class="text-xs text-slate-500 dark:text-slate-400 whitespace-nowrap">
                                {{ notification.created_at|timesince }} назад
                            </span>
                        </div>
                        <p class="text-sm text-slate-600 dark:text-slate-300 mt-1">
                            {{ notification.message }}
                        </p>
                        {% if notification.link %}
                        <a href="{{ notification.link }}"
                            class="inline-block mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-700 dark:text-indigo-400">
                            Посмотреть &rarr;
                        </a>
                        {% endif %}
                    </div>

                    <!-- Actions -->
                    {% if not notification.is_read %}
                    <div class="flex-shrink-0 self-center">
                        <button
                            class="mark-read-btn w-3 h-3 bg-indigo-600 rounded-full hover:bg-indigo-700 transition-colors"
                            data-id="{{ notification.id }}" title="Отметить как прочитанное"></button>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}

            <!-- Pagination -->
            {% if is_paginated %}
            <div class="mt-8 flex justify-center">
                <nav class="flex items-center gap-2">
                    {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}"
                        class="p-2 rounded-lg border border-slate-300 hover:bg-slate-50 dark:border-slate-600 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                    {% endif %}
                    <span class="px-4 py-2 text-slate-600 dark:text-slate-400">
                        {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                    </span>
                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}"
                        class="p-2 rounded-lg border border-slate-300 hover:bg-slate-50 dark:border-slate-600 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                    {% endif %}
                </nav>
            </div>
            {% endif %}

            {% else %}
            <div
                class="text-center py-16 bg-white dark:bg-slate-800 rounded-xl border border-dashed border-slate-300 dark:border-slate-700">
                <div
                    class="w-16 h-16 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="bi bi-bell-slash text-2xl text-slate-400"></i>
                </div>
                <h3 class="text-lg font-medium text-slate-900 dark:text-white mb-1">Нет уведомлений</h3>
                <p class="text-slate-500 dark:text-slate-400">Здесь будут отображаться важные события</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Mark single notification as read
        document.querySelectorAll('.mark-read-btn').forEach(btn => {
            btn.addEventListener('click', async function () {
                const id = this.dataset.id;
                try {
                    const response = await fetch(`/notifications/${id}/read/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    if (response.ok) {
                        // Remove highlight and button
                        const card = this.closest('.bg-indigo-50\\/50');
                        if (card) {
                            card.classList.remove('bg-indigo-50/50', 'dark:bg-indigo-900/10', 'border-indigo-200', 'dark:border-indigo-800');
                        }
                        this.remove();
                        // Update counter if exists
                        updateBadgeCount(-1);
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            });
        });

        // Mark all as read
        const markAllBtn = document.getElementById('mark-all-read');
        if (markAllBtn) {
            markAllBtn.addEventListener('click', async function () {
                try {
                    const response = await fetch('/notifications/read-all/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    if (response.ok) {
                        window.location.reload();
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function updateBadgeCount(change) {
            // Logic to update header badge would go here
        }
    });
</script>
{% endblock %}