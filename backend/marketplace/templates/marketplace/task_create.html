{% extends 'base.html' %}
{% load static %}

{% block title %}Создать задачу - ServiceHub{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-50 py-12 transition-colors duration-300 dark:bg-slate-900">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-10">
            <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Создать новую задачу</h1>
            <p class="mt-2 text-slate-500 dark:text-slate-400">Опишите задачу, и специалисты предложат свои услуги</p>
        </div>

        <div
            class="bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden transition-colors duration-300 dark:bg-slate-800 dark:border-slate-700">
            <!-- AI Helper Banner -->
            <div id="wizard-step-1"
                class="bg-indigo-50 border-b border-indigo-100 p-6 flex gap-4 dark:bg-indigo-900/20 dark:border-indigo-800">
                <div
                    class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center flex-shrink-0 dark:bg-indigo-800">
                    <i class="bi bi-magic text-indigo-600 text-xl dark:text-indigo-300"></i>
                </div>
                <div class="flex-1">
                    <h3 class="font-bold text-indigo-900 dark:text-indigo-300">Используйте ИИ для помощи</h3>
                    <p class="text-sm text-indigo-700 mt-1 dark:text-indigo-400">
                        Просто опишите задачу своими словами. Мы автоматически заполним детали, категорию и предложим
                        цену.
                    </p>
                    <div class="mt-4">
                        <textarea id="raw-task-input" rows="4"
                            class="w-full px-4 py-3 rounded-xl border border-indigo-200 bg-white focus:ring-2 focus:ring-indigo-500 outline-none text-slate-800 resize-none transition-colors dark:bg-slate-700 dark:border-indigo-700 dark:text-white dark:placeholder-slate-400"
                            placeholder="Например: Нужно починить протекающий кран на кухне..."></textarea>
                        <button id="analyze-task-btn" type="button"
                            class="mt-3 flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-semibold transition shadow-lg shadow-indigo-200 disabled:opacity-70 disabled:cursor-not-allowed">
                            <i class="bi bi-magic"></i> Проанализировать задачу
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-8" id="wizard-step-2">
                <form method="post" id="task-wizard-form" novalidate class="space-y-6">
                    {% csrf_token %}

                    <!-- Category -->
                    <div>
                        <label for="{{ form.category.id_for_label }}"
                            class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 dark:text-slate-400">
                            {{ form.category.label }} <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            {{ form.category }}
                            <!-- We'll use JS to style the select if needed, or rely on widget tweaks. 
                                 For now, we assume the widget renders a standard select which we can style via CSS or add classes in forms.py later. 
                                 Here we wrap it or target it with global CSS if possible, but better to add classes directly.
                                 Since we can't easily change forms.py right now without context, we'll wrap it and use CSS to target children or just accept default styling for now.
                            -->
                        </div>
                        {% if form.category.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.category.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Title -->
                    <div>
                        <label for="{{ form.title.id_for_label }}"
                            class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 dark:text-slate-400">
                            {{ form.title.label }} <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="{{ form.title.name }}" id="{{ form.title.id_for_label }}"
                            value="{{ form.title.value|default:'' }}"
                            class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none font-medium text-slate-800 transition-colors dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:focus:bg-slate-600"
                            placeholder="Например: Починить кран на кухне">
                        {% if form.title.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.title.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="{{ form.description.id_for_label }}"
                            class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 dark:text-slate-400">
                            {{ form.description.label }} <span class="text-red-500">*</span>
                        </label>
                        <textarea name="{{ form.description.name }}" id="{{ form.description.id_for_label }}" rows="5"
                            class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none text-slate-800 resize-none transition-colors dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:focus:bg-slate-600"
                            placeholder="Опишите детали задачи...">{{ form.description.value|default:'' }}</textarea>
                        {% if form.description.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.description.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Budget -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label
                                class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 dark:text-slate-400">Бюджет
                                (₽)</label>
                            <div class="flex gap-2 items-center">
                                <div class="flex-1">
                                    <input type="number" name="{{ form.budget_min.name }}"
                                        value="{{ form.budget_min.value|default:'' }}"
                                        class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white focus:ring-2 focus:ring-indigo-500 outline-none text-slate-800 transition-colors dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400"
                                        placeholder="От">
                                </div>
                                <span class="text-slate-400">-</span>
                                <div class="flex-1">
                                    <input type="number" name="{{ form.budget_max.name }}"
                                        value="{{ form.budget_max.value|default:'' }}"
                                        class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white focus:ring-2 focus:ring-indigo-500 outline-none text-slate-800 transition-colors dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400"
                                        placeholder="До">
                                </div>
                            </div>
                            {% if form.budget_min.errors or form.budget_max.errors %}
                            <p class="mt-1 text-sm text-red-600">Проверьте сумму бюджета</p>
                            {% endif %}
                        </div>

                        <!-- City -->
                        <div>
                            <label for="{{ form.city.id_for_label }}"
                                class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 dark:text-slate-400">
                                {{ form.city.label }} <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <i class="bi bi-geo-alt absolute left-4 top-3.5 text-slate-400"></i>
                                <input type="text" name="{{ form.city.name }}" id="{{ form.city.id_for_label }}"
                                    value="{{ form.city.value|default:'' }}"
                                    class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 bg-white focus:ring-2 focus:ring-indigo-500 outline-none text-slate-800 transition-colors dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400"
                                    placeholder="Ваш город">
                            </div>
                            {% if form.city.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.city.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Date & Time -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="{{ form.preferred_date.id_for_label }}"
                                class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 dark:text-slate-400">
                                {{ form.preferred_date.label }}
                            </label>
                            <input type="date" name="{{ form.preferred_date.name }}"
                                id="{{ form.preferred_date.id_for_label }}"
                                value="{{ form.preferred_date.value|default:'' }}"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white focus:ring-2 focus:ring-indigo-500 outline-none text-slate-800 transition-colors dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        </div>
                        <div>
                            <label for="{{ form.preferred_time.id_for_label }}"
                                class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 dark:text-slate-400">
                                {{ form.preferred_time.label }}
                            </label>
                            <input type="time" name="{{ form.preferred_time.name }}"
                                id="{{ form.preferred_time.id_for_label }}"
                                value="{{ form.preferred_time.value|default:'' }}"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white focus:ring-2 focus:ring-indigo-500 outline-none text-slate-800 transition-colors dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        </div>
                    </div>

                    <!-- Address -->
                    <div>
                        <label for="{{ form.address.id_for_label }}"
                            class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 dark:text-slate-400">
                            {{ form.address.label }}
                        </label>
                        <input type="text" name="{{ form.address.name }}" id="{{ form.address.id_for_label }}"
                            value="{{ form.address.value|default:'' }}"
                            class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none text-slate-800 transition-colors dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:focus:bg-slate-600"
                            placeholder="Улица, дом, квартира (необязательно)">
                    </div>

                    {% if form.non_field_errors %}
                    <div class="bg-red-50 border border-red-100 text-red-600 p-4 rounded-xl text-sm">
                        {{ form.non_field_errors }}
                    </div>
                    {% endif %}

                    <!-- Buttons -->
                    <div
                        class="flex items-center justify-end gap-4 pt-6 border-t border-slate-100 dark:border-slate-700">
                        <a href="{% url 'marketplace:tasks_list' %}"
                            class="text-slate-500 hover:text-slate-800 font-medium px-4 py-2 transition no-underline dark:text-slate-400 dark:hover:text-slate-200">
                            Отмена
                        </a>
                        <button type="submit"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg shadow-indigo-200 transform hover:-translate-y-0.5">
                            Создать задачу
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Custom styles for the select widget since we can't easily unstyle Django's default widget rendering without a custom widget -->
<style>
    select {
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
        background-color: #f8fafc;
        color: #1e293b;
        outline: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
    }


    select:focus {
        background-color: #ffffff;
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5);
    }

    /* Dark mode for select */
    .dark select {
        background-color: #334155;
        border-color: #475569;
        color: #f8fafc;
    }

    .dark select:focus {
        background-color: #1e293b;
        border-color: #818cf8;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const analyzeBtn = document.getElementById('analyze-task-btn');
        const rawInput = document.getElementById('raw-task-input');

        if (analyzeBtn && rawInput) {
            analyzeBtn.addEventListener('click', async function () {
                const text = rawInput.value.trim();
                if (!text) return;

                // Show loading state
                const originalText = analyzeBtn.innerHTML;
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = '<i class="bi bi-hourglass-split animate-spin"></i> Анализирую...';

                try {
                    const response = await fetch('/api/marketplace/ai/analyze-task/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({ description: text })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Populate form fields
                        if (data.title) document.getElementById('id_title').value = data.title;
                        if (data.description) document.getElementById('id_description').value = data.description;
                        if (data.city) document.getElementById('id_city').value = data.city;

                        if (data.budget_min) document.querySelector('[name="budget_min"]').value = data.budget_min;
                        if (data.budget_max) document.querySelector('[name="budget_max"]').value = data.budget_max;

                        if (data.preferred_date) document.getElementById('id_preferred_date').value = data.preferred_date;

                        // Handle Category Select
                        if (data.category_id) {
                            const categorySelect = document.getElementById('id_category');
                            if (categorySelect) {
                                categorySelect.value = data.category_id;
                            }
                        }

                        // Scroll to form
                        document.getElementById('wizard-step-2').scrollIntoView({ behavior: 'smooth' });
                    } else {
                        alert('Ошибка: ' + (data.error || 'Не удалось проанализировать задачу'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Произошла ошибка при обращении к AI сервису');
                } finally {
                    // Restore button state
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = originalText;
                }
            });
        }
    });
</script>
{% endblock %}