{% extends 'base.html' %}

{% block title %}Диалог{% endblock %}

{% block content %}
<div class="row h-100">
    <div class="col-md-8 mx-auto d-flex flex-column" style="height: calc(100vh - 200px);">
        <div class="card flex-grow-1 d-flex flex-column shadow-sm">
            <div class="card-header bg-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        {% if conversation.deal %}
                        Чат по сделке: {{ conversation.deal.task.title }}
                        {% else %}
                        Диалог
                        {% endif %}
                    </h5>
                    <div class="d-flex gap-2">
                        <button id="video-call-btn" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-camera-video"></i> Видеозвонок
                        </button>
                        <a href="{% url 'marketplace:my_deals' %}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> К сделкам
                        </a>
                    </div>
                </div>
            </div>

            <!-- Video Call Container (Hidden by default) -->
            <div id="video-call-container" class="d-none border-bottom" style="height: 400px;">
                <!-- Jitsi iframe will be inserted here -->
            </div>

            <div class="card-body overflow-auto flex-grow-1 bg-light" id="messages-container">
                {% for message in conversation.messages.all %}
                <div class="d-flex mb-3 {% if message.sender == user %}justify-content-end{% endif %}">
                    <div class="card border-0 shadow-sm {% if message.sender == user %}bg-primary text-white{% else %}bg-white{% endif %}"
                        style="max-width: 75%;">
                        <div class="card-body py-2 px-3">
                            <p class="mb-1">{{ message.text|linebreaksbr }}</p>
                            <div class="d-flex align-items-center justify-content-end gap-2">
                                <small
                                    class="{% if message.sender == user %}text-white-50{% else %}text-muted{% endif %}"
                                    style="font-size: 0.7rem;">
                                    {{ message.created_at|time:"H:i" }}
                                </small>
                                {% if message.sender == user %}
                                {% if message.is_read %}
                                <i class="bi bi-check-all text-white" style="font-size: 0.8rem;"></i>
                                {% else %}
                                <i class="bi bi-check text-white-50" style="font-size: 0.8rem;"></i>
                                {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div id="empty-chat-message" class="text-center py-5 text-muted">
                    <p>Начните общение первым!</p>
                </div>
                {% endfor %}
            </div>

            <div class="card-footer bg-white p-3">
                <form id="chat-form" class="d-flex gap-2">
                    <textarea id="chat-message-input" class="form-control" rows="1" placeholder="Напишите сообщение..."
                        required style="resize: none;"></textarea>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://meet.jit.si/external_api.js"></script>
<script>
    const conversationId = {{ conversation.id }};
    const currentUserId = {{ user.id }};
    const messagesContainer = document.getElementById('messages-container');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('chat-message-input');
    const videoCallBtn = document.getElementById('video-call-btn');
    const videoCallContainer = document.getElementById('video-call-container');

    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    // WebSocket Connection
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + conversationId + '/'
    );

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);

        if (data.type === 'chat_message') {
            appendMessage(data);
        } else if (data.type === 'video_call_start') {
            startVideoCall(data.sender_username);
        }
    };

    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    // Send Message
    chatForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
            chatSocket.send(JSON.stringify({
                'type': 'chat_message',
                'message': message
            }));
            messageInput.value = '';
        }
    });

    // Append Message to UI
    function appendMessage(data) {
        const isMe = data.sender_id === currentUserId;
        const emptyMessage = document.getElementById('empty-chat-message');
        if (emptyMessage) emptyMessage.remove();

        const messageHtml = `
            <div class="d-flex mb-3 ${isMe ? 'justify-content-end' : ''}">
                <div class="card border-0 shadow-sm ${isMe ? 'bg-primary text-white' : 'bg-white'}" style="max-width: 75%;">
                    <div class="card-body py-2 px-3">
                        <p class="mb-1">${data.message.replace(/\n/g, '<br>')}</p>
                        <div class="d-flex align-items-center justify-content-end gap-2">
                            <small class="${isMe ? 'text-white-50' : 'text-muted'}" style="font-size: 0.7rem;">
                                ${data.created_at.split(' ')[1]}
                            </small>
                            ${isMe ? '<i class="bi bi-check text-white-50" style="font-size: 0.8rem;"></i>' : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;

        messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Video Call Logic
    let api = null;

    videoCallBtn.addEventListener('click', function () {
        // Notify others
        chatSocket.send(JSON.stringify({
            'type': 'video_call_start'
        }));
    });

    function startVideoCall(initiatorName) {
        if (api) return; // Already in call

        videoCallContainer.classList.remove('d-none');
        const domain = 'meet.jit.si';
        const options = {
            roomName: 'ServiceHub_Conversation_' + conversationId,
            width: '100%',
            height: 400,
            parentNode: videoCallContainer,
            lang: 'ru',
            userInfo: {
                displayName: '{{ user.username }}'
            }
        };
        api = new JitsiMeetExternalAPI(domain, options);

        api.addEventListeners({
            videoConferenceLeft: function () {
                videoCallContainer.classList.add('d-none');
                api.dispose();
                api = null;
            }
        });
    }

    {% if conversation.video_call_started %}
    // If call was already active (reloaded page), show join button or auto-join?
    // For now, let's just let them click the button again.
    {% endif %}
</script>
{% endblock %}